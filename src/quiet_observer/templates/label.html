{% extends "base.html" %}
{% block title %}Label – {{ project.name }}{% endblock %}
{% block head %}
<style>
  #label-container { display: flex; gap: 1rem; align-items: flex-start; }
  #canvas-wrapper { position: relative; flex: 1; max-width: 800px; }
  #frame-img { display: block; max-width: 100%; }
  #label-canvas {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    cursor: crosshair;
  }
  #sidebar { width: 210px; flex-shrink: 0; }

  /* Class list */
  .cls-section-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.4rem;
  }
  .cls-section-header h3 { margin: 0; }
  #cls-list { margin-bottom: 0.5rem; }
  .cls-row {
    display: flex; align-items: center; gap: 0.35rem;
    padding: 0.25rem 0.3rem; border-radius: 4px;
    margin-bottom: 0.2rem; border: 2px solid transparent;
  }
  .cls-row.selected { background: #f0f4ff; border-color: #2563eb; }
  .cls-dot {
    width: 12px; height: 12px; border-radius: 50%;
    flex-shrink: 0; cursor: pointer;
  }
  .cls-name {
    flex: 1; font-size: 0.875rem; cursor: pointer;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .cls-name-input {
    flex: 1; font-size: 0.875rem;
    border: 1px solid #d1d5db; border-radius: 3px;
    padding: 0.1rem 0.3rem; min-width: 0;
  }
  .cls-btn {
    background: none; border: none; cursor: pointer;
    padding: 0 0.1rem; font-size: 0.85rem; color: #9ca3af; line-height: 1;
  }
  .cls-btn:hover { color: #374151; }
  .cls-btn.del:hover { color: #dc2626; }
  .cls-btn.confirm { color: #10b981; }
  .cls-btn.confirm:hover { color: #059669; }
  #add-cls-row {
    display: flex; gap: 0.3rem; margin-top: 0.3rem;
  }
  #new-cls-input {
    flex: 1; font-size: 0.8rem; min-width: 0;
    border: 1px solid #d1d5db; border-radius: 4px; padding: 0.25rem 0.4rem;
  }

  /* Annotations */
  #ann-list { margin-top: 0.75rem; }
  .ann-item {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 0.8rem; padding: 0.2rem 0;
    border-bottom: 1px solid #eee;
  }
  .ann-delete { background: none; border: none; cursor: pointer; color: #e74c3c; font-size: 1rem; }
</style>
{% endblock %}
{% block content %}
<div class="page-header">
  <div>
    <a href="/projects/{{ project.id }}" class="text-muted">← {{ project.name }}</a>
    <h1>Label Frame {{ frame_index }}/{{ total_frames }}</h1>
    {% if from_queue %}<span class="badge badge-orange">From Review Queue</span>{% endif %}
  </div>
  <div class="header-actions">
    {% if next_frame %}
    <a href="/projects/{{ project.id }}/label/{{ next_frame.id }}" class="btn btn-sm">← Newer</a>
    {% endif %}
    {% if prev_frame %}
    <a href="/projects/{{ project.id }}/label/{{ prev_frame.id }}" class="btn btn-sm">Older →</a>
    {% endif %}
  </div>
</div>

<div id="label-container">
  <div id="canvas-wrapper">
    <img id="frame-img" src="/frames/{{ frame.id }}/image" alt="Frame">
    <canvas id="label-canvas"></canvas>
  </div>

  <div id="sidebar">
    <!-- Classes -->
    <div class="cls-section-header">
      <h3>Classes</h3>
      <button class="btn btn-sm btn-primary" onclick="showAddClass()" id="add-cls-btn">+ Add</button>
    </div>
    <div id="cls-list"></div>
    <div id="add-cls-row" style="display:none">
      <input id="new-cls-input" placeholder="Class name"
             onkeydown="if(event.key==='Enter') commitAddClass(); if(event.key==='Escape') cancelAddClass()">
      <button class="cls-btn confirm" onclick="commitAddClass()" title="Add">✓</button>
      <button class="cls-btn del" onclick="cancelAddClass()" title="Cancel">✕</button>
    </div>

    <hr>
    <!-- Annotations -->
    <div id="ann-list">
      <h3>Annotations (<span id="ann-count">0</span>)</h3>
      <div id="ann-items"></div>
    </div>

    <hr>
    <div id="negative-banner" style="display:none; background:#fef3c7; border:1px solid #f59e0b; border-radius:6px; padding:0.5rem; margin-top:0.5rem; text-align:center; font-size:0.85rem; color:#92400e">
      Marked as <strong>No Objects</strong>
    </div>
    <button class="btn btn-primary" onclick="saveAnnotations()" style="width:100%; margin-top:0.5rem">
      Save
    </button>
    <button class="btn" onclick="markAsNegative()" id="mark-negative-btn" style="width:100%; margin-top:0.5rem">
      No Objects
    </button>
    <button class="btn" onclick="clearAll()" style="width:100%; margin-top:0.5rem">
      Clear all
    </button>
    {% if next_frame %}
    <button class="btn btn-sm" onclick="saveAndNext()" style="width:100%; margin-top:0.5rem">
      ← Save & Newer
    </button>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  const FRAME_ID = {{ frame.id }};
  const PROJECT_ID = {{ project.id }};
  const NEXT_FRAME_ID = {% if next_frame %}{{ next_frame.id }}{% else %}null{% endif %};
  const INITIAL_ANNOTATIONS = {{ annotations_json | safe }};
  const INITIAL_CLASSES = {{ classes_json | safe }};
  const LABEL_STATUS = "{{ frame.label_status or 'unlabeled' }}";
</script>
<script src="/static/label.js"></script>
{% endblock %}
