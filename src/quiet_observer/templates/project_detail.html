{% extends "base.html" %}
{% block title %}{{ project.name }} – Quiet Observer{% endblock %}
{% block content %}
<div class="page-header">
  <div>
    <h1>{{ project.name }}</h1>
    <p class="text-muted">{{ project.youtube_url }}</p>
  </div>
  <div class="header-actions">
    <a href="/projects/{{ project.id }}/edit" class="btn">Edit</a>
    <a href="/projects/{{ project.id }}/label" class="btn">Label</a>
    <a href="/projects/{{ project.id }}/train" class="btn">Train</a>
    <a href="/projects/{{ project.id }}/monitor" class="btn">Monitor</a>
  </div>
</div>

<div class="stats-row">
  <div class="stat-box">
    <div class="stat-value">{{ frame_count }}</div>
    <div class="stat-label">Frames</div>
  </div>
  <div class="stat-box">
    <div class="stat-value">{{ labeled_count }}</div>
    <div class="stat-label">Labeled</div>
  </div>
  <div class="stat-box">
    <div class="stat-value">{{ unlabeled_count }}</div>
    <div class="stat-label">Unlabeled</div>
  </div>
  <div class="stat-box">
    <div class="stat-value">{{ review_count }}</div>
    <div class="stat-label">In Review</div>
  </div>
</div>

<div class="two-col">
  <!-- Capture control -->
  <div class="card">
    <div class="card-header">
      <h2>Capture</h2>
      <div style="display:flex; align-items:center; gap:0.5rem">
        {% if capture_running %}
        <span class="badge badge-green">Running</span>
        <form method="post" action="/projects/{{ project.id }}/capture/stop">
          <button type="submit" class="btn btn-danger btn-sm">Stop</button>
        </form>
        {% else %}
        <span class="badge">Stopped</span>
        <form method="post" action="/projects/{{ project.id }}/capture/start">
          <button type="submit" class="btn btn-primary btn-sm">Start</button>
        </form>
        {% endif %}
      </div>
    </div>
    <p class="text-muted text-sm">Interval: every {{ project.capture_interval_seconds }}s &nbsp;·&nbsp; <strong>{{ frame_count }}</strong> frame{{ 's' if frame_count != 1 else '' }} captured</p>

    {% if latest_frame %}
    <a href="/projects/{{ project.id }}/label/{{ latest_frame.id }}" class="latest-frame-link">
      <img src="/frames/{{ latest_frame.id }}/image" alt="Latest frame" class="latest-frame-img">
    </a>
    <p class="text-muted text-sm" style="margin-top:0.4rem">
      Latest: {{ latest_frame.captured_at.strftime('%Y-%m-%d %H:%M:%S') }}
      {% if latest_frame.width and latest_frame.height %}
      &nbsp;·&nbsp; {{ latest_frame.width }}×{{ latest_frame.height }}
      {% endif %}
    </p>
    {% else %}
    <p class="text-muted text-sm" style="margin-top:0.5rem">No frames yet.</p>
    {% endif %}
  </div>

  <!-- Inference control -->
  <div class="card">
    <h2>Inference</h2>
    <p class="text-muted">Every {{ project.inference_interval_seconds }}s</p>
    {% if project.last_inference_at %}
    <p class="text-muted text-sm">Last: {{ project.last_inference_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
    {% endif %}
    {% if deployed_model %}
    <p class="text-muted text-sm">Model: v{{ deployed_model.id }}</p>
    {% else %}
    <p class="text-muted text-sm">No model deployed</p>
    {% endif %}
    {% if inference_running %}
    <span class="badge badge-blue">Running</span>
    <form method="post" action="/projects/{{ project.id }}/inference/stop">
      <button type="submit" class="btn btn-danger btn-sm">Stop</button>
    </form>
    {% else %}
    <span class="badge">Stopped</span>
    {% if deployed_model %}
    <form method="post" action="/projects/{{ project.id }}/inference/start">
      <button type="submit" class="btn btn-primary btn-sm">Start</button>
    </form>
    {% endif %}
    {% endif %}
  </div>
</div>

<!-- Classes -->
<div class="card">
  <div class="card-header">
    <h2>Classes</h2>
    <a href="/projects/{{ project.id }}/label" class="btn btn-sm">Manage in Label view</a>
  </div>
  {% if class_stats %}
  <table class="class-stats-table">
    <thead>
      <tr>
        <th>Class</th>
        <th class="text-right">Annotations</th>
      </tr>
    </thead>
    <tbody>
      {% for cls in class_stats %}
      <tr>
        <td>
          <span class="cls-dot-sm" style="background:{{ cls.color }}"></span>
          {{ cls.name }}
        </td>
        <td class="text-right text-muted">{{ cls.count }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-muted text-sm">No classes yet. Add them in the <a href="/projects/{{ project.id }}/label">Label view</a>.</p>
  {% endif %}
</div>

<!-- Recent Frames -->
{% if recent_frames %}
<div class="card">
  <div class="card-header">
    <h2>Recent Frames</h2>
    <a href="/projects/{{ project.id }}/label" class="btn btn-sm">Label All</a>
  </div>
  <div class="frame-grid">
    {% for frame in recent_frames %}
    <a href="/projects/{{ project.id }}/label/{{ frame.id }}" class="frame-thumb {% if frame.is_labeled %}labeled{% endif %}">
      <img src="/frames/{{ frame.id }}/image" alt="Frame {{ frame.id }}" loading="lazy">
      {% if frame.is_labeled %}<span class="frame-badge">✓</span>{% endif %}
      {% if frame.in_review_queue %}<span class="frame-badge review">?</span>{% endif %}
    </a>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if capture_running %}
<script>setTimeout(() => location.reload(), 5000);</script>
{% endif %}
{% endblock %}
